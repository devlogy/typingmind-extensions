// TypingMind Auto-Collapse Sidebar Extension v2.0 - FIXED
// Author: Devlogy Team - Probl√®me de r√©ouverture r√©solu
(function() {
    'use strict';
    
    console.log('üîß TypingMind Auto-Collapse Sidebar v2.0 (FIXED) charg√©e');
    
    // Configuration
    const CONFIG = {
        MAX_ATTEMPTS: 10,
        RETRY_DELAY: 500,
        INITIAL_DELAY: 1000,
        ANIMATION_DURATION: '0.3s'
    };
    
    let isExtensionActive = true;
    
    // Fonction pour nettoyer nos styles inline et laisser TypingMind reprendre le contr√¥le
    function cleanupCustomStyles() {
        console.log('üßπ Nettoyage des styles personnalis√©s...');
        
        const navContainer = document.querySelector('[data-element-id="nav-container"]');
        const mainContent = document.querySelector('[data-element-id="main-content-area"]');
        
        if (navContainer) {
            // Supprimer nos styles inline
            navContainer.style.removeProperty('transform');
            navContainer.style.removeProperty('transition');
            navContainer.removeAttribute('data-sidebar-collapsed');
        }
        
        if (mainContent) {
            mainContent.style.removeProperty('padding-left');
            mainContent.style.removeProperty('transition');
        }
        
        // Restaurer la variable CSS originale
        document.documentElement.style.removeProperty('--current-sidebar-width');
    }
    
    // Fonction pour collapser la sidebar (am√©lior√©e)
    function collapseSidebar() {
        if (!isExtensionActive) return false;
        
        // M√©thode 1: Bouton natif mobile
        const closeButton = document.querySelector('button[aria-label="Fermer la barre lat√©rale"]');
        if (closeButton && window.innerWidth < 768) {
            console.log('‚úÖ Collapse via bouton mobile');
            closeButton.click();
            return true;
        }
        
        // M√©thode 2: Manipulation CSS pour desktop
        const navContainer = document.querySelector('[data-element-id="nav-container"]');
        if (navContainer) {
            console.log('‚úÖ Collapse via CSS manipulation');
            
            // Variables CSS
            document.documentElement.style.setProperty('--current-sidebar-width', '0px');
            
            // Animation de la sidebar
            navContainer.style.transform = 'translateX(-384px)';
            navContainer.style.transition = `transform ${CONFIG.ANIMATION_DURATION} ease-in-out`;
            
            // Ajuster le contenu principal
            const mainContent = document.querySelector('[data-element-id="main-content-area"]');
            if (mainContent) {
                mainContent.style.paddingLeft = '0px';
                mainContent.style.transition = `padding-left ${CONFIG.ANIMATION_DURATION} ease-in-out`;
            }
            
            // Marquer comme collaps√©
            navContainer.setAttribute('data-sidebar-collapsed', 'true');
            return true;
        }
        
        return false;
    }
    
    // V√©rifier si d√©j√† collaps√© par notre extension
    function isCollapsedByExtension() {
        const navContainer = document.querySelector('[data-element-id="nav-container"]');
        return navContainer && navContainer.getAttribute('data-sidebar-collapsed') === 'true';
    }
    
    // D√©tecter si TypingMind veut ouvrir la sidebar
    function setupOpenSidebarListener() {
        // √âcouter les clics sur le bouton "Ouvrir la barre lat√©rale"
        document.addEventListener('click', function(event) {
            const button = event.target.closest('button[aria-label="Ouvrir la barre lat√©rale"]');
            if (button && isCollapsedByExtension()) {
                console.log('üîì Utilisateur veut ouvrir la sidebar - nettoyage des styles...');
                
                // D√©sactiver temporairement l'extension
                isExtensionActive = false;
                
                // Nettoyer nos styles pour laisser TypingMind reprendre le contr√¥le
                cleanupCustomStyles();
                
                // R√©activer l'extension apr√®s un d√©lai
                setTimeout(() => {
                    isExtensionActive = true;
                    console.log('üîÑ Extension r√©activ√©e');
                }, 2000);
                
                showNotification('‚ÜîÔ∏è Sidebar ouverte');
            }
        });
    }
    
    // Observer les changements de variables CSS de TypingMind
    function setupCSSVariableObserver() {
        const observer = new MutationObserver(() => {
            // V√©rifier si --current-sidebar-width a chang√©
            const currentWidth = getComputedStyle(document.documentElement)
                .getPropertyValue('--current-sidebar-width').trim();
            
            // Si TypingMind a restaur√© la largeur et que notre extension n'est pas active
            if (currentWidth === '384px' && isCollapsedByExtension() && !isExtensionActive) {
                console.log('üìè D√©tection changement CSS - nettoyage...');
                cleanupCustomStyles();
            }
        });
        
        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['style']
        });
    }
    
    // Fonction d'initialisation avec retry
    function initCollapse(attempts = 0) {
        if (attempts >= CONFIG.MAX_ATTEMPTS) {
            console.log('‚ùå Auto-collapse √©chou√© apr√®s', CONFIG.MAX_ATTEMPTS, 'tentatives');
            return;
        }
        
        if (!isExtensionActive) {
            console.log('‚è∏Ô∏è Extension temporairement d√©sactiv√©e');
            return;
        }
        
        // V√©rifier que les √©l√©ments sont charg√©s
        const navContainer = document.querySelector('[data-element-id="nav-container"]');
        const sidebarBg = document.querySelector('[data-element-id="side-bar-background"]');
        
        if (navContainer && sidebarBg && !isCollapsedByExtension()) {
            console.log('üéØ Sidebar d√©tect√©e, collapse en cours... (tentative', attempts + 1, ')');
            
            setTimeout(() => {
                if (collapseSidebar()) {
                    console.log('üéâ Sidebar auto-collaps√©e avec succ√®s !');
                    showNotification('‚úÖ Sidebar auto-collaps√©e');
                } else {
                    setTimeout(() => initCollapse(attempts + 1), CONFIG.RETRY_DELAY);
                }
            }, 100);
        } else if (isCollapsedByExtension()) {
            console.log('‚ÑπÔ∏è Sidebar d√©j√† collaps√©e par l\'extension');
        } else {
            setTimeout(() => initCollapse(attempts + 1), CONFIG.RETRY_DELAY);
        }
    }
    
    // Notification discr√®te
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #22c55e;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 10000;
            transition: opacity 0.3s ease;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        `;
        
        document.body.appendChild(notification);
        
        // Disparition automatique
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 2000);
    }
    
    // Observer g√©n√©ral pour les changements de page
    function setupGeneralObserver() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList' && isExtensionActive) {
                    // V√©rifier si une nouvelle sidebar a √©t√© cr√©√©e (navigation)
                    const navContainer = document.querySelector('[data-element-id="nav-container"]');
                    if (navContainer && !isCollapsedByExtension()) {
                        // D√©lai pour √©viter les conflits avec les animations de TypingMind
                        setTimeout(() => {
                            if (isExtensionActive && !isCollapsedByExtension()) {
                                console.log('üîÑ Nouvelle sidebar d√©tect√©e, collapse...');
                                collapseSidebar();
                            }
                        }, 1500);
                    }
                }
            });
        });
        
        if (document.body) {
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
    }
    
    // Fonction toggle manuelle am√©lior√©e
    window.toggleSidebarCollapse = function() {
        if (isCollapsedByExtension()) {
            console.log('üîì Toggle manuel - ouverture');
            isExtensionActive = false;
            cleanupCustomStyles();
            showNotification('‚ÜîÔ∏è Sidebar ouverte manuellement');
            
            // R√©activer apr√®s d√©lai
            setTimeout(() => {
                isExtensionActive = true;
            }, 2000);
        } else {
            console.log('üîí Toggle manuel - fermeture');
            collapseSidebar();
        }
    };
    
    // Point d'entr√©e principal
    function init() {
        console.log('üöÄ Initialisation Auto-Collapse Sidebar v2.0...');
        
        // Configuration des listeners
        setupOpenSidebarListener();
        setupCSSVariableObserver();
        setupGeneralObserver();
        
        // D√©marrer le collapse initial
        setTimeout(() => initCollapse(), CONFIG.INITIAL_DELAY);
    }
    
    // D√©marrage
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    console.log('üéâ Auto-Collapse Sidebar Extension v2.0 FIXED charg√©e !');
    console.log('üí° Tapez toggleSidebarCollapse() pour un toggle manuel.');
    console.log('üîß La sidebar peut maintenant √™tre rouverte normalement !');
})();

